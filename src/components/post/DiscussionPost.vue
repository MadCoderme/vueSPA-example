<script setup lang="ts">  
import '@/assets/common.css' 
import '@/assets/post.css'

import { ref, computed, onMounted } from 'vue'
import DiscussionText from './DiscussionText.vue'
import type { PostDataType } from '@/lib/types/supabaseext'
import { useDiscussionApi } from '@/stores/posts'
 
const api = useDiscussionApi()
const props = defineProps<{
    item?: PostDataType
}>()
const item = computed(() => props?.item)
const isLoved = ref(false)
const commentInput = ref('')
const isLoading = ref(true)
const discussions = ref()

onMounted(() => {
    if(props?.item?.id) {
        api.getPostDiscussion(props.item.id)
        .then(res => {
            discussions.value = res
            isLoading.value = false
        })
    }
})

function handleComment() {
    if(commentInput.value.length > 0 && item.value?.id)
    {
        api.createComment(item.value?.id, commentInput.value)
            .then(res => {
                if (res === 201) {
                    console.log('commented')
                    commentInput.value = ''
                }
            })
    }
}
</script>

<template>
    <div 
        class="post-body" 
        style="margin-bottom: 20vh">

        <button class="post-more-options">
            <svg width="23" height="20" viewBox="0 0 23 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path opacity="0.2" d="M13.5222 10C13.5222 10.3708 13.403 10.7334 13.1797 11.0417C12.9564 11.35 12.639 11.5904 12.2677 11.7323C11.8963 11.8742 11.4877 11.9113 11.0935 11.839C10.6992 11.7666 10.3371 11.588 10.0529 11.3258C9.76866 11.0636 9.5751 10.7295 9.49668 10.3658C9.41827 10.0021 9.45851 9.62508 9.61233 9.28247C9.76615 8.93986 10.0266 8.64702 10.3608 8.44099C10.6951 8.23497 11.088 8.125 11.4899 8.125C12.0289 8.125 12.5459 8.32254 12.927 8.67417C13.3081 9.02581 13.5222 9.50272 13.5222 10ZM4.7156 8.125C4.31365 8.125 3.92073 8.23497 3.58652 8.44099C3.25231 8.64702 2.99182 8.93986 2.838 9.28247C2.68418 9.62508 2.64394 10.0021 2.72235 10.3658C2.80077 10.7295 2.99433 11.0636 3.27855 11.3258C3.56277 11.588 3.92489 11.7666 4.31912 11.839C4.71335 11.9113 5.12198 11.8742 5.49333 11.7323C5.86468 11.5904 6.18209 11.35 6.4054 11.0417C6.62871 10.7334 6.7479 10.3708 6.7479 10C6.7479 9.50272 6.53379 9.02581 6.15266 8.67417C5.77153 8.32254 5.2546 8.125 4.7156 8.125ZM18.2643 8.125C17.8623 8.125 17.4694 8.23497 17.1352 8.44099C16.801 8.64702 16.5405 8.93986 16.3867 9.28247C16.2328 9.62508 16.1926 10.0021 16.271 10.3658C16.3494 10.7295 16.543 11.0636 16.8272 11.3258C17.1114 11.588 17.4736 11.7666 17.8678 11.839C18.262 11.9113 18.6706 11.8742 19.042 11.7323C19.4133 11.5904 19.7307 11.35 19.9541 11.0417C20.1774 10.7334 20.2966 10.3708 20.2966 10C20.2966 9.50272 20.0824 9.02581 19.7013 8.67417C19.3202 8.32254 18.8033 8.125 18.2643 8.125Z" fill="white" fill-opacity="0.6"/>
                <path d="M11.4899 7.5C10.954 7.5 10.4301 7.64662 9.98448 7.92133C9.53887 8.19603 9.19156 8.58648 8.98646 9.04329C8.78137 9.50011 8.72771 10.0028 8.83226 10.4877C8.93682 10.9727 9.1949 11.4181 9.57386 11.7678C9.95282 12.1174 10.4356 12.3555 10.9613 12.452C11.4869 12.5484 12.0318 12.4989 12.5269 12.3097C13.022 12.1205 13.4452 11.8 13.743 11.3889C14.0407 10.9778 14.1997 10.4945 14.1997 10C14.1997 9.33696 13.9142 8.70107 13.406 8.23223C12.8978 7.76339 12.2086 7.5 11.4899 7.5ZM11.4899 11.25C11.222 11.25 10.96 11.1767 10.7372 11.0393C10.5144 10.902 10.3407 10.7068 10.2382 10.4784C10.1356 10.2499 10.1088 9.99861 10.1611 9.75614C10.2134 9.51366 10.3424 9.29093 10.5319 9.11612C10.7214 8.9413 10.9628 8.82225 11.2256 8.77402C11.4884 8.72579 11.7608 8.75054 12.0084 8.84515C12.256 8.93976 12.4676 9.09998 12.6165 9.30554C12.7653 9.5111 12.8448 9.75277 12.8448 10C12.8448 10.3315 12.7021 10.6495 12.448 10.8839C12.1939 11.1183 11.8493 11.25 11.4899 11.25ZM4.7156 7.5C4.17967 7.5 3.65577 7.64662 3.21015 7.92133C2.76454 8.19603 2.41723 8.58648 2.21213 9.04329C2.00704 9.50011 1.95338 10.0028 2.05793 10.4877C2.16249 10.9727 2.42057 11.4181 2.79953 11.7678C3.17849 12.1174 3.66132 12.3555 4.18696 12.452C4.71259 12.5484 5.25743 12.4989 5.75257 12.3097C6.24771 12.1205 6.67091 11.8 6.96866 11.3889C7.26641 10.9778 7.42533 10.4945 7.42533 10C7.42533 9.33696 7.13984 8.70107 6.63167 8.23223C6.1235 7.76339 5.43427 7.5 4.7156 7.5ZM4.7156 11.25C4.44763 11.25 4.18568 11.1767 3.96288 11.0393C3.74007 10.902 3.56641 10.7068 3.46387 10.4784C3.36132 10.2499 3.33449 9.99861 3.38677 9.75614C3.43904 9.51366 3.56808 9.29093 3.75756 9.11612C3.94705 8.9413 4.18846 8.82225 4.45128 8.77402C4.7141 8.72579 4.98652 8.75054 5.23408 8.84515C5.48165 8.93976 5.69325 9.09998 5.84213 9.30554C5.991 9.5111 6.07047 9.75277 6.07047 10C6.07047 10.3315 5.92772 10.6495 5.67363 10.8839C5.41955 11.1183 5.07493 11.25 4.7156 11.25ZM18.2643 7.5C17.7283 7.5 17.2044 7.64662 16.7588 7.92133C16.3132 8.19603 15.9659 8.58648 15.7608 9.04329C15.5557 9.50011 15.502 10.0028 15.6066 10.4877C15.7111 10.9727 15.9692 11.4181 16.3482 11.7678C16.7272 12.1174 17.21 12.3555 17.7356 12.452C18.2613 12.5484 18.8061 12.4989 19.3012 12.3097C19.7964 12.1205 20.2196 11.8 20.5173 11.3889C20.8151 10.9778 20.974 10.4945 20.974 10C20.974 9.33696 20.6885 8.70107 20.1803 8.23223C19.6722 7.76339 18.9829 7.5 18.2643 7.5ZM18.2643 11.25C17.9963 11.25 17.7343 11.1767 17.5115 11.0393C17.2887 10.902 17.1151 10.7068 17.0125 10.4784C16.91 10.2499 16.8831 9.99861 16.9354 9.75614C16.9877 9.51366 17.1167 9.29093 17.3062 9.11612C17.4957 8.9413 17.7371 8.82225 17.9999 8.77402C18.2628 8.72579 18.5352 8.75054 18.7827 8.84515C19.0303 8.93976 19.2419 9.09998 19.3908 9.30554C19.5397 9.5111 19.6191 9.75277 19.6191 10C19.6191 10.3315 19.4764 10.6495 19.2223 10.8839C18.9682 11.1183 18.6236 11.25 18.2643 11.25Z" fill="white" fill-opacity="0.6"/>
            </svg>
        </button>

        <DiscussionText :value="props?.item?.discussionRoot?.text" :isOrigin="true" />
        <svg width="10" height="54" viewBox="0 0 10 54" class="origin-flow" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M 1 19 L 1 54 C 1 0 1 20 1 13 C 1 6 3 1 9 1" stroke="#A3F7BF" stroke-opacity="0.5" stroke-width="3"
                stroke-linecap="round" />
        </svg>
        <DiscussionText :value="props?.item?.text as string" />
        <div v-if="!isLoading">
            <DiscussionText v-for="item in discussions" :key="item.id" :value="item.text" />
        </div>

        <div class="comment-input" style="position: inherit;">
            <textarea 
                placeholder="Write something..."
                @input="commentInput = ($event.target as HTMLInputElement).value"
                style="border-radius: 15px;"
                :value="commentInput"></textarea>
            <button class="comment-share-btn" 
                    style="float: right; position: relative;"
                    v-show="commentInput.length > 0"
                    @click="handleComment()">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path opacity="0.16" d="M7.24 4.535L19.184 10.193C20.709 10.915 20.709 13.085 19.184 13.807L7.24 19.465C5.825 20.135 4.223 18.993 4.396 17.437L4.976 12.221C4.99233 12.0741 4.99233 11.9259 4.976 11.779L4.396 6.563C4.223 5.007 5.825 3.864 7.24 4.535Z" fill="#A3F7BF" />
                    <path d="M5 12L4.396 6.563C4.223 5.007 5.825 3.864 7.24 4.535L19.184 10.193C20.709 10.915 20.709 13.085 19.184 13.807L7.24 19.465C5.825 20.135 4.223 18.993 4.396 17.437L5 12ZM5 12H12" stroke="#A3F7BF"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button
                    style="float: right; position: relative;"
                    :class="{'comment-sticker-btn-d': commentInput.length == 0, 'comment-sticker-btn-2-d': commentInput.length > 0}">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.791 13.342C17.572 13.069 18.543 13.032 20.571 13.028H21.997C21.99 13.125 22.007 12.931 21.997 13.028C21.9657 13.3708 21.8158 13.6919 21.573 13.936L13.923 21.626C13.8055 21.7436 13.666 21.8368 13.5124 21.9003C13.3588 21.9638 13.1942 21.9963 13.028 21.996C12.931 22.006 13.125 21.99 13.028 21.996V20.572C13.033 18.542 13.069 17.572 13.342 16.792C13.6209 15.9947 14.0759 15.2705 14.6732 14.6732C15.2705 14.0759 15.9937 13.6209 16.791 13.342Z" fill="#A3F7BF" />
                    <path opacity="0.5" d="M13.028 21.948C12.6864 21.9825 12.3433 21.9999 12 22C6.477 22 2 17.523 2 12C2 6.477 6.477 2 12 2C17.523 2 22 6.477 22 12C22 12.347 21.982 12.69 21.948 13.028H20.57C18.542 13.033 17.571 13.069 16.79 13.342C15.9929 13.621 15.2688 14.0761 14.6717 14.6733C14.0746 15.2706 13.6198 15.9948 13.341 16.792C13.068 17.572 13.031 18.542 13.027 20.572L13.028 21.948Z" fill="#A3F7BF" />
                    <path d="M14.898 11.224C15.431 11.081 15.69 10.316 15.476 9.51599C15.261 8.71599 14.655 8.18299 14.121 8.32599C13.588 8.46899 13.329 9.23299 13.544 10.034C13.758 10.834 14.364 11.367 14.898 11.224ZM9.10202 12.777C9.63602 12.634 9.89402 11.869 9.68002 11.069C9.46602 10.269 8.86002 9.73599 8.32602 9.87899C7.79202 10.022 7.53402 10.786 7.74802 11.587C7.96302 12.387 8.56802 12.92 9.10202 12.777ZM9.09502 15.206C8.90208 15.1576 8.69781 15.1878 8.52715 15.29C8.35649 15.3922 8.23342 15.558 8.18502 15.751C8.13662 15.9439 8.16685 16.1482 8.26905 16.3189C8.37126 16.4895 8.53708 16.6126 8.73002 16.661C10.117 17.008 11.674 17.005 13.23 16.588L13.282 16.574L13.362 16.737C13.6458 15.9521 14.1009 15.2402 14.6942 14.6531C15.2875 14.0661 16.0041 13.6185 16.792 13.343C16.884 13.31 16.98 13.281 17.079 13.255C16.9363 13.1521 16.762 13.1026 16.5865 13.1152C16.411 13.1278 16.2455 13.2017 16.119 13.324C15.281 14.134 14.159 14.787 12.841 15.14C11.523 15.493 10.225 15.49 9.09502 15.206Z" fill="#A3F7BF" />
                </svg>
            </button>
        </div>

        <div class="post-buttons discussion-btns">
                <button @click="isLoved = !isLoved">
                    <svg width="32" height="31" viewBox="0 0 27 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M23.8684 7.20078C23.5281 6.41275 23.0374 5.69865 22.4237 5.09844C21.8096 4.49644 21.0855 4.01805 20.2909 3.68926C19.4669 3.34698 18.5831 3.17178 17.6909 3.17383C16.4391 3.17383 15.2179 3.5166 14.1565 4.16407C13.9026 4.31895 13.6614 4.48907 13.4329 4.67442C13.2044 4.48907 12.9632 4.31895 12.7093 4.16407C11.6479 3.5166 10.4266 3.17383 9.17488 3.17383C8.27352 3.17383 7.40008 3.34649 6.57488 3.68926C5.77762 4.01934 5.05906 4.49414 4.44207 5.09844C3.82761 5.69797 3.33676 6.41224 2.99734 7.20078C2.64442 8.0209 2.46414 8.8918 2.46414 9.78809C2.46414 10.6336 2.6368 11.5147 2.97957 12.4109C3.26649 13.16 3.67781 13.9369 4.2034 14.7215C5.03621 15.9631 6.18133 17.258 7.6032 18.5707C9.95945 20.7467 12.2929 22.2498 12.3919 22.3107L12.9936 22.6967C13.2602 22.8668 13.603 22.8668 13.8696 22.6967L14.4714 22.3107C14.5704 22.2473 16.9013 20.7467 19.26 18.5707C20.6819 17.258 21.827 15.9631 22.6598 14.7215C23.1854 13.9369 23.5993 13.16 23.8837 12.4109C24.2264 11.5147 24.3991 10.6336 24.3991 9.78809C24.4016 8.8918 24.2214 8.0209 23.8684 7.20078ZM13.4329 20.6883C13.4329 20.6883 4.39383 14.8967 4.39383 9.78809C4.39383 7.20078 6.53426 5.10352 9.17488 5.10352C11.0309 5.10352 12.6407 6.13946 13.4329 7.65274C14.2251 6.13946 15.8348 5.10352 17.6909 5.10352C20.3315 5.10352 22.472 7.20078 22.472 9.78809C22.472 14.8967 13.4329 20.6883 13.4329 20.6883Z" fill="#E74C3C"/>
                        <path d="M17.6909 5.10352C15.8348 5.10352 14.2251 6.13945 13.4329 7.65273C12.6407 6.13945 11.0309 5.10352 9.17488 5.10352C6.53426 5.10352 4.39383 7.20078 4.39383 9.78809C4.39383 14.8967 13.4329 20.6883 13.4329 20.6883C13.4329 20.6883 22.472 14.8967 22.472 9.78809C22.472 7.20078 20.3315 5.10352 17.6909 5.10352Z" fill="#E74C3C" :fill-opacity="isLoved ? 1 : 0.2"/>
                    </svg>
                    <span>1.5k</span>
                </button>
                <button>
                    <svg width="32" height="31" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path opacity="0.16" d="M12.4329 21C14.2129 21 15.953 20.4722 17.433 19.4832C18.9131 18.4943 20.0666 17.0887 20.7478 15.4442C21.429 13.7996 21.6072 11.99 21.26 10.2442C20.9127 8.49836 20.0555 6.89472 18.7969 5.63604C17.5382 4.37737 15.9345 3.5202 14.1887 3.17294C12.4429 2.82567 10.6333 3.0039 8.98874 3.68509C7.34421 4.36628 5.9386 5.51983 4.94967 6.99987C3.96073 8.47991 3.43289 10.22 3.43289 12C3.43289 13.488 3.79289 14.89 4.43289 16.127L3.43289 21L8.30589 20C9.54189 20.639 10.9459 21 12.4329 21Z" fill="white" fill-opacity="0.7"/>
                        <path d="M12.4329 21C14.2129 21 15.953 20.4722 17.433 19.4832C18.9131 18.4943 20.0666 17.0887 20.7478 15.4442C21.429 13.7996 21.6072 11.99 21.26 10.2442C20.9127 8.49836 20.0555 6.89472 18.7969 5.63604C17.5382 4.37737 15.9345 3.5202 14.1887 3.17294C12.4429 2.82567 10.6333 3.0039 8.98874 3.68509C7.34421 4.36628 5.9386 5.51983 4.94967 6.99987C3.96073 8.47991 3.43289 10.22 3.43289 12C3.43289 13.488 3.79289 14.89 4.43289 16.127L3.43289 21L8.30589 20C9.54189 20.639 10.9459 21 12.4329 21Z" stroke="white" stroke-opacity="0.7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>1.5k</span>
                </button>
                <button>
                    <svg width="32" height="32" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_14_63)">
                        <path d="M6.05789 10.25C5.95844 10.25 5.86305 10.2895 5.79273 10.3598C5.7224 10.4302 5.68289 10.5255 5.68289 10.625V20.375C5.68289 20.582 5.85089 20.75 6.05789 20.75H18.8079C18.9073 20.75 19.0027 20.7105 19.0731 20.6402C19.1434 20.5698 19.1829 20.4745 19.1829 20.375V10.625C19.1829 10.5255 19.1434 10.4302 19.0731 10.3598C19.0027 10.2895 18.9073 10.25 18.8079 10.25H17.3079C17.0095 10.25 16.7234 10.1315 16.5124 9.9205C16.3014 9.70952 16.1829 9.42337 16.1829 9.125C16.1829 8.82664 16.3014 8.54049 16.5124 8.32951C16.7234 8.11853 17.0095 8 17.3079 8H18.8079C20.2569 8 21.4329 9.176 21.4329 10.625V20.375C21.4329 21.0712 21.1563 21.7389 20.664 22.2312C20.1718 22.7234 19.5041 23 18.8079 23H6.05789C5.3617 23 4.69402 22.7234 4.20174 22.2312C3.70945 21.7389 3.43289 21.0712 3.43289 20.375V10.625C3.43289 9.176 4.60889 8 6.05789 8H7.55789C7.85626 8 8.14241 8.11853 8.35339 8.32951C8.56437 8.54049 8.68289 8.82664 8.68289 9.125C8.68289 9.42337 8.56437 9.70952 8.35339 9.9205C8.14241 10.1315 7.85626 10.25 7.55789 10.25H6.05789ZM12.1674 0.765505C12.2022 0.730582 12.2436 0.702875 12.2892 0.68397C12.3347 0.665066 12.3836 0.655334 12.4329 0.655334C12.4822 0.655334 12.5311 0.665066 12.5766 0.68397C12.6222 0.702875 12.6636 0.730582 12.6984 0.765505L17.0424 5.1095C17.095 5.16195 17.1308 5.22883 17.1453 5.30166C17.1598 5.37449 17.1524 5.45 17.124 5.5186C17.0955 5.58721 17.0474 5.64582 16.9856 5.68702C16.9238 5.72822 16.8512 5.75014 16.7769 5.75H13.5579V14.375C13.5579 14.6734 13.4394 14.9595 13.2284 15.1705C13.0174 15.3815 12.7313 15.5 12.4329 15.5C12.1345 15.5 11.8484 15.3815 11.6374 15.1705C11.4264 14.9595 11.3079 14.6734 11.3079 14.375V5.75H8.08889C8.01463 5.75014 7.94199 5.72822 7.8802 5.68702C7.81841 5.64582 7.77024 5.58721 7.7418 5.5186C7.71337 5.45 7.70594 5.37449 7.72046 5.30166C7.73499 5.22883 7.77081 5.16195 7.82339 5.1095L12.1674 0.765505Z" fill="white" fill-opacity="0.7"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_14_63">
                        <rect width="24" height="24" fill="white" transform="translate(0.432892 0.5)"/>
                        </clipPath>
                        </defs>
                    </svg>
                    <span>1.5k</span>
                </button>
            </div>
    </div>
</template>

<style scoped>
.discussion-btns {
    background-color: var(--c-black-mute);
    padding: 1px;
    position: absolute;
    bottom: var(--bottom-menu-height);
    left: 0px;
    right: 0px;
    z-index: 10;
}
.origin-flow {
    margin-left: 16px;
    margin-bottom: 10px;
}
</style>